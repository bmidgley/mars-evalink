<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVALink Main Map</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- Include OpenLayers library -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v10.4.0/ol.css" type="text/css">
    <script src="https://cdn.jsdelivr.net/npm/ol@10.4.0/dist/ol.js"></script>
    <style>
        html,
        body {
            font-size: 12px;
        }

        #map {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }

        #info {
            position: absolute;
            display: inline-block;
            height: auto;
            width: auto;
            z-index: 100;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 5px;
            left: 50%;
            transform: translateX(3%);
            visibility: hidden;
            pointer-events: none;
        }

        .popup {
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            background-color: white;
            font-family: 'Roboto', sans-serif;
        }

        #marker-list {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            font-family: 'Roboto', sans-serif;
        }

        .marker-item {
            margin-bottom: 5px;
            cursor: pointer;
            font-family: 'Roboto', sans-serif;
        }

        #time-slider-container {
            width: 350px;
            position: absolute;
            bottom: 60px;
            right: 10px;
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
        }

        #emergency-device-panel {
            position: fixed;
            bottom: 170px;
            left: 10px;
            background-color: #fff;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            max-height: 200px;
            width: 200px;
            overflow-y: auto;
        }

        #emergency-device-panel h3 {
            margin-top: 0;
            font-size: 16px;
            color: #333;
            font-family: 'Roboto', sans-serif;
        }

        #emergency-device-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #emergency-device-list li {
            margin-bottom: 5px;
            font-size: 14px;
            color: #555;
            font-family: 'Roboto', sans-serif;
            animation: blink 1.5s infinite;
            cursor: pointer;
        }

        #emergency-device-list li a {
            text-decoration: none;
        }

        .modal-body {
            padding: 20px;
        }

        #message-tab {
            position: absolute;
            width: 200px;
            bottom: 40px;
            left: 10px;
            background-color: #fff;
            z-index: 2;
            border-radius: 5px;

            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        #geo-tab {
            position: absolute;
            width: 275px;
            height: 35px;
            top: 8px;
            left: 30px;
            background-color: #fff;
            z-index: 2;
            border-radius: 5px;

            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        #layerButton {
            position: absolute;
            top: 15px;
            left: 310px;
        }

        #historyButton {
            position: absolute;
            top: 15px;
            left: 370px;
        }

        #message-tab form {
            display: flex;
            flex-direction: column;
            padding:0px;
        
        }
        form input {
            margin: 3px;
        }

        .list-group-item {
            list-style: none;
            padding: 10px;
            /* background-color: #f8f9fa; */
            border: 1px solid #dee2e6;
        }

        .list-group-item:last-child {
            border-bottom-right-radius: 0.25rem;
            border-bottom-left-radius: 0.25rem;
        }

        .list-group-item {
            list-style: none;
        }

        @keyframes blink {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }
        }

        .close-btn {
            position: absolute;
            top: -8px;
            right: 5px;
            font-size: 25px;
            cursor: pointer;
        }

        /* Style the tab */
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
        }

        /* Style the buttons inside the tab */
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 17px;
        }

        /* Change background color of buttons on hover */
        .tab button:hover {
            background-color: #ddd;
        }

        /* Create an active/current tablink class */
        .tab button.active {
            background-color: #ccc;
        }

        /* Style the tab content */
        .tab-content {
            display: none;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
        }

        #bi-previous {
            float: left;
        }
        #selected-time {
            display: inline;
        }
        #bi-following {
            float: right;
        }


    </style>
</head>

<body>
    <div id="map">
        <a href="https://www.maptiler.com" style="position:absolute;right:260px;bottom:5px;z-index:999;"><img
                src="https://api.maptiler.com/resources/logo.svg" alt="MapTiler logo"></a>
        <div id="info"></div>
    </div>

    <div id="marker-list"></div>


    <div id="time-slider-container">
        <button id="time-slider-close" type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
        <h3 id="nameTimeSlider"></h3>
        <div id="batteryTimeSlider"></div>
        <select id="ddlCrews"></select>
        <button type="button" class="btn btn-success" title="Add Crew" onclick="addCrew()">
            <span class="bi bi-person-plus"></span>
        </button>
        <button type="button" class="btn btn-danger" title="Remove Crew" onclick="removeCrew()">
            <span class="bi bi-person-dash"></span>
        </button>
        <button type="button" class="btn btn-primary" title="View Crew" onclick="viewCrew()">
            <span class="bi bi-eye"></span>
        </button>
        <br>
        <input type="range" class="form-control-range" id="time-slider" min="0" max="1" step="0.1" value="0">
        <div id="time-area">
            <button id="previous-day" type="button" class="btn" title="Display previous day's tracks" onclick="populatePath(window.current_name, window.current_date, null)">
                <span class="bi bi-previous"><<</span>
            </button>
            <div id="selected-time"></div>
            <button id="following-day" type="button" class="btn" title="Display following day's tracks" onclick="populatePath(window.current_name, null, window.current_date)">
                <span class="bi bi-next">>></span>
            </button>
            <br>
            <span id="latestLink"></span>
        </div>
        <button id="download-button" title="Download Tracks For Selection">
            <img src="https://img.icons8.com/material-outlined/24/000000/download.png" height="30" width="30" />
        </button>
        <p id="time-slider-coordinates">0,0</p>
    </div>

    <div id="message-tab" class="hidden">
        <h3>Messages</h3>
        <ul id="message-list"></ul>
        <form class="form" method="post" id="message-post">
            <input type="text" name="message" class="form-control" id="form-control" placeholder="Message ..." required>
            
            <input type="submit" value="Send Message">
        </form>
    </div>

    <div id="geo-tab">
        <p id="geo-coordinates"></p>
    </div>

    <button type="button" id="layerButton" onclick="changeLayer();">
        Remap
    </button>

    <div id="historyButton">
        <button type="button" onclick="populateHistory()">
            Search area...
        </button>
        <select id="historyDropdown" onChange="populateUrlPath(this.options[this.selectedIndex].value);">
        </select>
    </div>

    <div id="emergency-device-panel" class="hidden">
        <h3>Emergency Device List</h3>
        <ul id="emergency-device-list"></ul>
    </div>

    <div class="modal fade" id="crewModal" tabindex="-1" role="dialog" aria-labelledby="crewModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="crewModalLabel">Crew Details</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <ul class="list-group" id="passengerList">
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let clipboarding = false;
        navigator.permissions.query({ name: "clipboard-write" }).then((result) => {
            if (result.state === "granted" || result.state === "prompt") {
                clipboarding = true;
            }
        });
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const geojsonUrl =
            '/features.json';
        const key = 'VfcvzosbIEMkLMsjWMpz';
        const info = document.getElementById('info');
        const attribution = new ol.control.Attribution({
            collapsible: false,
        });
        const scaleLine = new ol.control.ScaleLine();

        layerName = localStorage.getItem("layerName") || "topo"
        const source = new ol.source.TileJSON({
            url: `https://api.maptiler.com/maps/${layerName}/tiles.json?key=${key}`, // source URL
            tileSize: 512,
            crossOrigin: 'anonymous',
        });

        let markerData = {};
        let timeSliderVisible = false;
        let emergencyList = [];
        let geojsonData;
        let deviceCrew = [];
        let waypoints = [];
        const selectedTime = document.getElementById('selected-time');
        const selectedCoordinate = document.getElementById('time-slider-coordinates');

        function formattedDate(date_string) {
            date = new Date(date_string);
            return date.toLocaleTimeString('sv', { 
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit', 
            });
        }

        function changeLayer() {
            layerName = localStorage.getItem("layerName") || "topo";
            nextLayer = { "topo": "outdoor", "outdoor": "hybrid", "hybrid": "topo" };
            localStorage.setItem("layerName", nextLayer[layerName]);
            location.reload();
        }

        async function populateHistory() {
            var dropdown = document.getElementById("historyDropdown");
            dropdown.innerHTML = ""; // Clear existing options

            const glbox = map.getView().calculateExtent(map.getSize());
            const box = ol.proj.transformExtent(glbox,'EPSG:3857','EPSG:4326');
            const url = `/search?latitude1=${box[1]}&longitude1=${box[0]}&latitude2=${box[3]}&longitude2=${box[2]}`;
            const response = await fetch(url);
            const paths = await response.json();

            const blankOption = document.createElement("option");
            blankOption.value = "";
            blankOption.text = `${paths.items.length} results found`;
            dropdown.add(blankOption, 0);
            blankOption.style.display = "none";

            paths.items.forEach(path => {
                var option1 = document.createElement("option");
                option1.text = path.name;
                option1.value = path.url;
                dropdown.add(option1);
            })
        }

        function displayWaypoints() {
            for(const point of waypoints) {
                let formattedTime = formattedDate(point.updated_at);
                let coordinates = ol.proj.fromLonLat([point.longitude, point.latitude]);
                drawTemporaryMarker(coordinates, "flag", `[${formattedTime}] ${point.text}`);
            }
        }

        async function checkTexts(firstRun) {
            if(firstRun) window.seenTextId = 0;
            var response = await fetch("/texts.json");
            const messages = await response.json();
            const message_list_el = document.getElementById("message-list");
            message_list_el.innerHTML = "";
            for(const message of messages) {
                if(message["station_type"] == "ignore") continue;
                const li = document.createElement("li");
                const markerItem = document.createElement("div");
                const markerText = document.createElement("div");
                const name = message.station;
                if(markerData[name]) {
                    markerItem.innerHTML = message.station + "⌖";
                } else {
                    markerItem.innerHTML = message.station;
                }
                markerItem.className = "marker-list";
                markerItem.addEventListener('click', function () {
                    if(markerData[name]) {
                        // activate commonpanel
                        populatePath(name);
                        zoomToMarker(name);
                        populateCrewDropdown(name);
                    }
                });
                if(message["position"][0] != null) {
                    markerText.addEventListener('click', function () {
                        const coordinates = ol.proj.fromLonLat([message["position"][1], message["position"][0]])
                        map.getView().animate({
                            center: coordinates,
                            zoom: 17,
                            duration: 1000,
                        });
                    })
                    markerText.innerHTML = message.text + "⌖";
                } else {
                    markerText.innerHTML = message.text;
                }
                li.appendChild(markerItem);
                li.appendChild(markerText);
                message_list_el.appendChild(li);
                if(window.seenTextId < message.id) {
                    const content = message.station + ': ' + message.text;
                    if (Notification.permission === "granted") {
                        if(!firstRun) { new Notification(content) }
                    } else if (Notification.permission !== "denied") {
                        Notification.requestPermission().then((permission) => {
                            if (permission === "granted") {
                                new Notification(content)
                            }
                        });
                    }
                    window.seenTextId = message.id;
                }
            }
        }
        checkTexts(true)
        setInterval(checkTexts, 15000);

        function updateGeoJSON() {
            fetch(geojsonUrl)
                .then(response => response.json())
                .then(data => {
                    // vectorSource holds stations
                    vectorSource.clear();
                    displayWaypoints();
                    let geojsonData = data;

                    const features = vectorSource.getFormat().readFeatures(data, {
                        featureProjection: map.getView().getProjection(),
                    });

                    let onEva = []
                    features.forEach(feature => {

                        const id = feature.get('id');
                        const name = feature.get('name');
                        const time = feature.get('time');
                        const battery = feature.get('battery_level');
                        const temperature = feature.get('temperature');
                        const coordinates = feature.getGeometry().getCoordinates();
                        const days_old = feature.get('days_old') || 0;

                        if (feature.get('node_type') == 'person' && feature.get('distance') > 0 && days_old == 0) {
                            onEva.push(name)
                        }

                        if (name && time) {
                            if (!markerData[name]) {
                                markerData[name] = {
                                    times: [],
                                    coordinates: [],
                                    id: id,
                                };
                            }
                            markerData[name].time = time;
                            markerData[name].temperature = temperature;
                            markerData[name].battery = battery;
                        }

                        if (emergencyList.includes(name)) {
                            feature.set('emergency', true);
                        } else {
                            feature.set('emergency', false);
                        }
                    });
                    if(window.evaAlerted == undefined) window.evaAlerted = Date.now();
                    if(onEva.length > 0) {
                        if(Date.now() - window.evaAlerted > 1000 * 600 && document.visibilityState !== "visible") {
                            const content = `On EVA: ${onEva.join()}`
                            if (Notification.permission === "granted") {
                                new Notification(content)
                            } else if (Notification.permission !== "denied") {
                                Notification.requestPermission().then((permission) => {
                                    if (permission === "granted") {
                                        new Notification(content)
                                    }
                                });
                            }
                            window.evaAlerted = Date.now();
                        }
                    }

                    vectorSource.addFeatures(features);

                    updateMarkerList();
                    if (timeSliderVisible) {
                        updateSlider();
                    }
                })
                .catch(error => console.error('Error loading GeoJSON:', error));
        }

        function updateMarkerList() {
            const markerList = document.getElementById('marker-list');
            markerList.innerHTML = '';

            Object.keys(markerData).forEach(name => {
                const markerItem = document.createElement('div');
                markerItem.className = 'marker-item';
                markerItem.textContent = name;
                markerItem.addEventListener('click', function () {
                    // activate commonpanel
                    populatePath(name);
                    zoomToMarker(name);
                    populateCrewDropdown(name);
                });
                markerList.appendChild(markerItem);
            });
            const downloadJsonButton = document.createElement('button');
            downloadJsonButton.id = 'download-json-button';
            downloadJsonButton.title = 'Download All JSON Data';
            downloadJsonButton.innerHTML = '<img src="https://img.icons8.com/material-outlined/24/000000/download.png"/>';
            downloadJsonButton.addEventListener('click', function () {
                downloadAllData();
            });

            // markerList.appendChild(downloadJsonButton);
        }

        function populateUrlPath(url) {
            const queryParams = new URLSearchParams(url);
            const params = {};
            for (const [key, value] of queryParams.entries()) {
                params[key] = value;
            }
            populatePath(params.name, params.before_date, params.after_date)
        }

        async function populatePath(name, before_date, after_date) {
            vectorTrackSource.clear();
            var prefix = "/path.json?"
            const base_params = `name=${name}&id=${markerData[name].id}`
            var params = base_params;
            if(before_date) params += "&before_date=" + before_date
            if(after_date) params += "&after_date=" + after_date
            var response = await fetch(`${prefix}${params}`);
            const data = await response.json();
            markerData[name].coordinates = [];
            markerData[name].times = [];
            markerData[name].altitudes = [];
            markerData[name].waypoints = data.waypoints;
            markerData[name].hardware_name = data.hardware_name;
            var pointList = [];
            for(const point of data.points) {
                var projection = ol.proj.fromLonLat([point.longitude, point.latitude]);
                const altitude = point.altitude;
                pointList.push([point.longitude, point.latitude]);
                markerData[name].coordinates.push(projection);
                markerData[name].times.push(point.updated_at);
                if(altitude) markerData[name].altitudes.push(altitude);
            }
            waypoints = data.waypoints;
            displayWaypoints();
            var route = new ol.geom.LineString(pointList).transform('EPSG:4326', 'EPSG:3857');
            var feature = new ol.Feature({
                geometry : route,
            });
            vectorTrackSource.addFeature(feature);
            showTimeSlider(name, `${window.location.pathname}?${params}`, `${window.location.pathname}?${base_params}`);
            window.current_name = name;
            window.current_date = data.date;
        }

        function battery_text(battery, temperature, isotime) {
            temperature_text = "";
            if(temperature) {
                temperature_text = `${temperature.toFixed(1)}c `;
            }
            if(battery == null) return `No internal battery ${temperature_text}-- ${battery_age(isotime)}`
            if(battery == 101) return `Plugged in, charged ${temperature_text}-- ${battery_age(isotime)}`
            return `${battery}% ${temperature_text}-- ${battery_age(isotime)}`
        }

        function battery_age(isotime) {
            const date = new Date(isotime);
            const now = new Date();
            const hours = Math.round((now - date) / (1000 * 360)) / 10;
            const days = Math.round((now - date) / (1000 * 3600 * 24));

            if(hours <= 1) {
                return "current";
            } else if (hours < 48) {
                return `${hours} hours ago`;
            } else {
                return `${days} days ago`;
            }
        }

        function updateSliderStats(times, coordinates, value) {
            const index = parseInt(value, 10);
            const selected = times[index];

            moveMarkerToCoordinates(coordinates[index]);

            const geo = ol.proj.toLonLat(coordinates[index]);
            const lat = geo[1].toFixed(7);
            const lon = geo[0].toFixed(7);
            var speed = 0;

            if(index > 0) {
                var line = new ol.geom.LineString([coordinates[index], coordinates[index-1]]);
                var meters = ol.sphere.getLength(line);
                var seconds = (Date.parse(times[index]) - Date.parse(times[index-1])) / 1000
                if(seconds > 0) speed = (3.6 * (meters / seconds)).toFixed(1)
                if(speed < 0.1) speed = 0;
                if(speed > 10) speed = speed.toFixed(0)
            }

            selectedTime.textContent = `Time: ${formattedDate(selected)} ${speed}kph`;
            selectedCoordinate.innerHTML = `
                <a href="http://maps.google.com/maps?z=12&t=k&q=loc:${lat}+${lon}" target="_blank">${lat},${lon}</a>
                <button onclick="if(clipboarding){navigator.clipboard.writeText('${lat},${lon}');window.alert('copied ${lat},${lon}');}">Copy</button>
            `;
        };

        function showTimeSlider(name, url, base_url) {
            const times = markerData[name].times;
            const coordinates = markerData[name].coordinates;
            const battery = markerData[name].battery;
            const temperature = markerData[name].temperature;
            const time = markerData[name].time;
            const timeSliderContainer = document.getElementById('time-slider-container');
            const timeSlider = document.getElementById('time-slider');
            const closeButton = document.getElementById('time-slider-close')
            document.getElementById('nameTimeSlider').innerHTML = `<a id="nameTimeSliderName" href="${url}">${name}</a>`;
            document.getElementById('batteryTimeSlider').innerHTML = battery_text(battery, temperature, time);
            document.getElementById('latestLink').innerHTML = `<a href="${base_url}">(see latest)</a>`;

            const emergencyIcon = document.getElementById('emergency-icon');
            if(emergencyIcon) {
                if (emergencyList.includes(name)) {
                    emergencyIcon.src = 'https://img.icons8.com/ios-filled/50/FF0000/siren.png';
                } else {
                    emergencyIcon.src = 'https://img.icons8.com/ios-filled/50/000000/siren.png';
                }
            }

            timeSlider.disabled = times.length <= 1;

            timeSlider.setAttribute('max', times.length - 1);
            timeSlider.value = times.length - 1;

            timeSlider.oninput = function () {
                updateSliderStats(times, coordinates, timeSlider.value);
            };

            closeButton.onclick = function() {
                timeSliderContainer.style.display = 'none';
            }

            timeSliderContainer.style.display = 'block';
            updateSliderStats(times, coordinates, timeSlider.value);
        }

        function createSvgDataURL(nodeType, r, g, b) {
            const style = `style="fill: rgb(216, 216, 216); stroke: rgb(${r}, ${g}, ${b});"`
            // https://boxy-svg.com/app/new:CC8D9BcATq
            const svgTower = `
            <svg enable-background="new 0 0 24 24" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:bx="https://boxy-svg.com">
                <defs/>
                <path d="M 11.818 2.261 L 18.06 22.098 L 5.576 22.098 L 11.818 2.261 Z" ${style} bx:shape="triangle 5.576 2.261 12.484 19.837 0.5 0 1@d4deb6fe"/>
            </svg>`;

            const svgAntenna = `
            <svg enable-background="new 0 0 24 24" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:bx="https://boxy-svg.com">
                <defs/>
                <path d="M 11.877 6.696 L 17.614 22.638 L 6.139 22.638 L 11.877 6.696 Z" ${style} bx:shape="triangle 6.139 6.696 11.475 15.942 0.5 0 1@6606973a"/>
                <ellipse ${style} cx="11.98" cy="5.358" rx="1.233" ry="1.22"/>
                <line ${style} x1="17.114" y1="22.235" x2="7.929" y2="17.386"/>
                <line ${style} x1="8.376" y1="17.054" x2="14.662" y2="13.765"/>
                <line ${style} x1="14.243" y1="13.616" x2="10.356" y2="10.124"/>
                <line ${style} x1="6.603" y1="22.305" x2="15.825" y2="17.131"/>
                <line ${style} x1="15.436" y1="17.013" x2="9.309" y2="13.658"/>
                <line ${style} x1="13.305" y1="10.218" x2="9.606" y2="13.416"/>
            </svg>`;

            const svgPerson = `
                <svg id="Layer_2" data-name="Layer 2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384.42 817.51" height="20" width="9">
                    <g>
                        <path d="M380.53,471.66c5.06-38.19,17.95-169.47-64.37-245.63-7.81-7.22-16.78-14.24-27.12-20.71-9.67,7.16-24.21,16.31-43.49,23.14-19.29,6.82-36.36,8.87-48.38,9.38-.02,12.6-.04,172.98-.06,201.01,0,1.47-1.17,2.68-2.63,2.71-2.12,.04-4.22,.03-6.29-.03-1.46-.04-2.61-1.26-2.61-2.72V237.77c-34.25-2.66-65.62-11.85-91.62-32.46-12.44,8.18-22.83,16.99-31.54,25.84C-16.46,311.3-.33,437.9,5.11,472.13c23.98,3.36,47.96,6.72,71.93,10.08v-136.01c4.18-.54,8.36-1.09,12.54-1.63,.14,152.19,.28,244.39,.42,396.58h95.57v-219.99c0-1.21,.98-2.19,2.19-2.19h7.16c1.21,0,2.19,.98,2.19,2.19v219.99h98.22c0-151.65,0-243.3,.01-394.95h12.55c.29,45.34,.57,90.67,.86,136.01,23.93-3.52,47.86-7.03,71.78-10.55Zm-241.14-205.19h7.21c1.07,0,1.93,.86,1.93,1.93v7.19c0,1.07-.86,1.93-1.93,1.93h-7.21c-1.07,0-1.93-.86-1.93-1.93v-7.19c0-1.07,.86-1.93,1.93-1.93Zm-18.18,0h7.2c1.07,0,1.93,.86,1.93,1.93v7.19c0,1.07-.86,1.93-1.93,1.93h-7.2c-1.07,0-1.93-.86-1.93-1.93v-7.19c0-1.07,.86-1.93,1.93-1.93Zm34.17,107.31c-8.33-.11-16.66-.1-24.99-.02-3.01,.03-4.13-1.31-4.11-4.24,.07-11.49,.06-22.99,.01-34.48-.01-2.76,1.18-3.88,3.92-3.85,8.5,.07,16.99,.08,25.49-.02,3.03-.04,4.14,1.22,4.07,4.19-.12,5.83-.03,11.66-.03,17.49-.01,5.5-.12,11,.04,16.49,.09,3.24-1.2,4.48-4.4,4.44Zm9.4-96.26h-7.21c-1.07,0-1.93-.86-1.93-1.93v-7.19c0-1.07,.86-1.93,1.93-1.93h7.21c1.07,0,1.93,.86,1.93,1.93v7.19c0,1.07-.86,1.93-1.93,1.93Zm100.39,14.58h-46.04c-1.07,0-1.93-.86-1.93-1.93v-21.77c0-1.07,.86-1.93,1.93-1.93h46.04c1.07,0,1.93,.86,1.93,1.93v21.77c0,1.07-.86,1.93-1.93,1.93Z" style="fill: rgb(${r}, ${g}, ${b});"/>
                        <path d="M190.86,0c-56.36,.48-101.63,46.46-101.39,103,.25,55.69,45.58,100.69,101.4,100.64,56.65-.04,101.84-44.3,102.03-99.89C293.1,45.81,247.56-.49,190.86,0Zm65.37,162.37c-36.1,31.11-98.75,29.78-132.38-2.8-31.06-30.08-27.42-73.34,8.33-97.92,17.84-12.26,37.91-17.49,59.3-18.23,22.71,.77,43.72,6.71,61.88,20.59,34.36,26.28,35.52,70.22,2.87,98.36Z" style="fill: rgb(${r}, ${g}, ${b});"/>
                        <path d="M104.64,199.88c3.62-2.21,8.08-4.48,13.39-6.31,2.11-.73,4.14-1.31,6.06-1.77,8.14,5.8,33.63,22.32,69.86,21.45,21.02-.5,42.13-7.37,63.25-21.05,2.11,.35,4.36,.82,6.71,1.44,5.34,1.41,9.93,3.26,13.73,5.12-10.12,7.63-40.16,28.21-83.86,29.23-46.69,1.09-79.21-20.83-89.13-28.11Z" style="fill: rgb(${r}, ${g}, ${b});"/>
                        <path d="M68.81,208.2v-66.99c6.19,.45,12.37,.9,18.56,1.36,2.63,6.08,6.35,13.31,11.61,20.93,5.85,8.47,11.96,15.03,17.17,19.9-7.81,3.17-16.26,7.02-25.11,11.69-8.2,4.34-15.61,8.78-22.22,13.11Z" style="fill: rgb(${r}, ${g}, ${b});"/>
                        <path d="M294.75,142.53c6.41-.44,12.81-.88,19.22-1.32,0,22.54-.02,45.08-.03,67.61-6.33-4.34-13.69-8.89-22.1-13.25-9.03-4.69-17.56-8.27-25.21-11.04,5-5.02,10.74-11.59,16.26-19.88,5.38-8.08,9.17-15.71,11.85-22.12Z" style="fill: rgb(${r}, ${g}, ${b});"/>
                        <path d="M301.27,77.86c15.31,15.03,13.44,48.06-2.65,54.71,4.46-17.86,3.55-34.62,2.65-54.71Z" style="fill: rgb(${r}, ${g}, ${b});"/>
                        <path d="M81.06,77.86c-15.31,15.03-13.44,48.06,2.65,54.71-4.46-17.86-3.55-34.62-2.65-54.71Z" style="fill: rgb(${r}, ${g}, ${b});"/>
                        <rect x="224.19" y="275.9" width="35.64" height="6.77"/>
                        <path d="M237.68,64.32c-14.23-8.13-29.81-11.2-46.85-11.54-19.59,.25-38.62,5.18-55.11,17.5-33.32,24.89-31.52,69.66,4.2,91.06,31.77,19.04,65.21,19.87,97.92,2.83,19.48-10.16,33.17-26.32,32.9-49.91-.28-23.31-13.68-38.87-33.06-49.94Zm12.87,40.29c-.28,.08-.57,.13-.84,.13-1.25,0-2.39-.81-2.77-2.06-1.75-5.81-5.59-14.17-13.9-21.12-10.62-8.86-22.37-10.18-28.43-10.18-1.59,0-2.9-1.31-2.9-2.9s1.31-2.9,2.9-2.9c3.42,0,8.45,.38,14.13,2,5.68,1.64,12,4.51,18.03,9.54,9.39,7.85,13.74,17.31,15.72,23.88,.47,1.52-.4,3.14-1.94,3.61Z" style="fill: rgb(${r}, ${g}, ${b});"/>
                        <path d="M224.19,275.9v6.77h35.64v-6.77h-35.64Z" style="fill: rgb(${r}, ${g}, ${b});"/>
                        <path d="M41.07,553.44h0c-19.86,0-35.97-16.1-35.97-35.97v-35.97l71.93,10v25.97c0,19.86-16.1,35.97-35.97,35.97Z" style="fill: rgb(${r}, ${g}, ${b});"/>
                        <path d="M344.71,553.44h0c19.86,0,35.97-16.1,35.97-35.97v-35.97s-71.93,10-71.93,10v25.97c0,19.86,16.1,35.97,35.97,35.97Z" style="fill: rgb(${r}, ${g}, ${b});"/>
                        <path d="M89.81,748.44h95.67v21.24c0,26.4-21.43,47.83-47.83,47.83h0c-26.4,0-47.83-21.43-47.83-47.83v-21.24h0Z" style="fill: rgb(${r}, ${g}, ${b});"/>
                        <path d="M198.19,748.44h95.67v21.24c0,26.4-21.43,47.83-47.83,47.83h0c-26.4,0-47.83-21.43-47.83-47.83v-21.24h0Z" style="fill: rgb(${r}, ${g}, ${b});"/>
                    </g>
                </svg>
            `;

            // https://uxwing.com/map-marker-flag-icon/
            // https://boxy-svg.com/app/disk:pjLK0dMimb
            const svgFlag = `
                <svg xmlns="http://www.w3.org/2000/svg" shape-rendering="geometricPrecision" text-rendering="geometricPrecision" image-rendering="optimizeQuality" fill-rule="evenodd" clip-rule="evenodd" viewBox="0 0 492 512.14" height="20" width="20">
                    <path d="M169.28 262.03c153.59 11.89 145.6-75.49 322.72-117.27C366.3 36.78 268.32 110.2 169.28 23.8v-2.79c0-11.6-9.41-21.01-21.01-21.01-11.6 0-21.01 9.41-21.01 21.01V399.3c0 11.6 9.41 21.01 21.01 21.01 11.6 0 21.01-9.41 21.01-21.01V262.03zm41.08 60.37c22.35 2.82 44.63 13.66 60.84 30 15.78 15.92 26.09 37 26.09 61.29 0 15.75-5.76 31.07-16.31 44.8-9.42 12.25-22.83 23.3-39.35 32.09-12.77 6.79-27.59 12.33-44.01 16.08-15.36 3.51-31.94 5.48-49.35 5.48-16.23 0-31.74-1.71-46.19-4.77-15.48-3.28-29.54-8.11-41.83-14.05C34 480.61 17.13 463.58 8.11 445.17c-7.83-15.99-9.77-32.84-6.77-48.96 2.88-15.55 10.38-30.1 21.55-42.15 14.79-15.94 36.28-27.68 62-31.31l4.07 37.3c-18.14 2.57-32.95 10.48-42.84 21.14-6.31 6.81-10.49 14.65-11.98 22.69-1.38 7.47-.41 15.43 3.37 23.15 5.59 11.42 17.15 22.52 35.99 31.64 10.26 4.96 21.95 8.98 34.75 11.7 12.19 2.58 25.61 4.02 40.02 4.02 15.47 0 29.79-1.65 42.66-4.6 13.63-3.11 25.89-7.68 36.4-13.27 12.28-6.53 21.92-14.33 28.32-22.66 5.2-6.77 8.04-13.69 8.04-20.17 0-12.74-5.85-24.24-14.8-33.27-11.06-11.15-26.52-18.58-42.2-20.56l3.67-37.46z" style="fill: rgb(${r}, ${g}, ${b});"/>
                </svg>
            `;

            let icons = {"person": svgPerson, "infrastructure": svgTower, "antenna": svgAntenna, "flag": svgFlag};

            return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(icons[nodeType] || svgTower);
        }

        function drawTemporaryMarker(coordinates, icon, label) {
            const temporaryMarker = new ol.Feature({
                geometry: new ol.geom.Point(coordinates),
                label: label,
            });

            temporaryMarker.setStyle(
                new ol.style.Style({
                    image: new ol.style.Icon({
                        src: createSvgDataURL(icon, 0, 0, 255),
                        imgSize: [24, 24],
                        anchor: [0.5, 1],
                        anchorXUnits: 'fraction',
                        anchorYUnits: 'fraction',
                    }),
                })
            );

            vectorSource.addFeature(temporaryMarker);
        }

        function moveMarkerToCoordinates(coordinates) {
            vectorSource.getFeatures().forEach(feature => {
                const name = feature.get('name');
                if (name) {
                    if (name in markerData && markerData[name].coordinates.length > 0) {
                        feature.getGeometry().setCoordinates(coordinates);
                    }
                }
            });
        }

        function updateSlider() {
            const timeSlider = document.getElementById('time-slider');
            const times = Object.values(markerData).reduce((acc, data) => [...acc, ...data.times], []);
            timeSlider.setAttribute('max', times.length - 1);
        }

        const vectorSource = new ol.source.Vector({
            format: new ol.format.GeoJSON(),
            strategy: ol.loadingstrategy.bbox,
        });

        const vectorLayer = new ol.layer.Vector({
            source: vectorSource,
            style: function (feature) {
                const eva_lost = (feature.get('distance') > 0 && feature.get('hours_old') > 1);
                const untracked = feature.get('hours_old') > 12;
                const emergency = feature.get('emergency') || untracked || eva_lost;
                const nodeType = feature.get('node_type')
                const coordinates = feature.getGeometry().getCoordinates();
                var icon = emergency ? createSvgDataURL(nodeType, 180, 128, 128) : createSvgDataURL(nodeType, 0, 0, 0)
 
                return new ol.style.Style({
                    image: new ol.style.Icon({
                        src: icon,
                        imgSize: [24, 24],
                        anchor: [0.5, 1],
                        anchorXUnits: 'fraction',
                        anchorYUnits: 'fraction',
                    }),
                });
            },
        });

        const vectorTrackSource = new ol.source.Vector({
            format: new ol.format.GeoJSON(),
            strategy: ol.loadingstrategy.bbox,
        });

        const vectorTrackLayer = new ol.layer.Vector({
            source: vectorTrackSource,
        });

        const map = new ol.Map({
            target: 'map',
            controls: ol.control.defaults.defaults({
                attribution: false,
            }).extend([attribution, scaleLine]),
            layers: [
                new ol.layer.Tile({
                    source: source,
                }),
                vectorLayer,
                vectorTrackLayer,
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([-110.7919148, 38.4065268]),
                zoom: 13,
            }),
        });

        document.addEventListener('keydown', function(event) {
            if(event.key == "z") map.getView().setRotation(Math.PI);
        });

        document.addEventListener('keyup', function(event) {
            if(event.key == "z") map.getView().setRotation(0);
        });

        const overlay = new ol.Overlay({
            element: document.createElement('div'),
            positioning: 'bottom-center',
            stopEvent: false,
            offset: [0, -10],
        });
        map.addOverlay(overlay);

        map.on('click', function (event) {
            const feature = map.forEachFeatureAtPixel(event.pixel, function (feature) {
                return feature;
            });

            if (feature) {
                const name = feature.get("name");

                if(name) {
                    // activate commonpanel
                    populatePath(name);
                    // zoomToMarker(name);
                    populateCrewDropdown(name);
                } else {
                    info.style.left = event.pixel[0] + 'px';
                    info.style.top = event.pixel[1] + 'px';
                    info.style.visibility = 'visible';
                    info.innerText = feature.get("label");
                }
            }
        });

        map.on('pointermove', function (event) {
            if (event.dragging) {
                overlay.setPosition(undefined);
                return;
            }
            const pixel = map.getEventPixel(event.originalEvent);
            const hit = map.hasFeatureAtPixel(pixel);
            map.getTargetElement().style.cursor = hit ? 'pointer' : '';

            const feature = map.forEachFeatureAtPixel(event.pixel, function (feature) {
                return feature;
            });
            const geo = ol.proj.toLonLat(map.getCoordinateFromPixel(pixel));
            const geo_el = document.getElementById("geo-coordinates");
            const lat = geo[1].toFixed(7)
            const lon = geo[0].toFixed(7)
            geo_el.innerHTML = `${lat},${lon}`;

            if(feature && !feature.get("name") && feature.get("label")) {
                info.style.left = event.pixel[0] + 'px';
                info.style.top = event.pixel[1] + 'px';
                info.style.visibility = 'visible';
                info.innerText = feature.get("label");
            } else {
                info.style.visibility = 'hidden';
            }
        });

        setInterval(updateGeoJSON, 9000);

        updateGeoJSON();

        function closeOverlay() {
            overlay.setPosition(undefined);
        }

        function openCity(evt, cityName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(cityName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        function downloadSelected() {
            const name = document.getElementById('nameTimeSliderName').innerHTML;
            const data = markerData[name];

            if (data) {
                const header = `
<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<gpx xmlns="http://www.topografix.com/GPX/1/1" version="1.1" creator="Wikipedia"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd">
    <metadata>
        <name>${name}</name>
        <desc>${name} tracks from ${data.times[0]} device ${data.hardware_name}</desc>
    </metadata>`;
                const footer = `
        </trkseg>
    </trk>
</gpx>`;
                var body = "";
                for(let i = 0; i < data.waypoints.length; i++) {
                    let wp = data.waypoints[i];
                    body += `
    <wpt lat="${wp.latitude}" lon="${wp.longitude}">
        <time>${wp.updated_at}</time>
        <name>${wp.text}</name>`
                    if(wp.altitude)
                        body += `
        <ele>${wp.altitude}</ele>`;
                    body += `
    </wpt>`;
                }
                body += `
    <trk>
        <name>${name} from ${data.times[0]}</name>
        <trkseg>`;
                for(let i = 0; i < data.times.length; i++) {
                    coordinates = ol.proj.toLonLat(data.coordinates[i])
                    body += `
            <trkpt lat="${coordinates[1]}" lon="${coordinates[0]}">
                <time>${data.times[i]}</time>`;
                if(data.altitudes[i]) body += `
                 <ele>${data.altitudes[i]}</ele>`;
                 body += `
            </trkpt>`;
                }

                var content = `${header}${body}${footer}`;

                const blob = new Blob([content], { type: 'application/gpx+xml' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `${name}_${data.times[0]}.gpx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        function downloadAllData() {
            let allData = [];

            Object.keys(markerData).forEach(name => {
                const jsonData = {
                    name: name,
                    times: markerData[name].times,
                    coordinates: markerData[name].coordinates.map(coord => ol.proj.toLonLat(coord))
                };

                allData.push(jsonData);
            });

            const jsonContent = JSON.stringify(allData);

            const blob = new Blob([jsonContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'all_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function sendEmergencySignal() {
            const name = document.getElementById('nameTimeSliderName').innerHTML;

            if (name && !emergencyList.includes(name)) {
                const emergencyIcon = document.getElementById('emergency-icon');
                emergencyIcon.src = 'https://img.icons8.com/ios-filled/50/FF0000/siren.png';
                addToEmergencyList(name);
                console.log(`Emergency signal sent for device "${name}"`);
            }
        }

        function addToEmergencyList(deviceName) {
            const emergencyListPanel = document.getElementById('emergency-device-list');

            console.log(emergencyList);
            if (!emergencyList.includes(deviceName)) {
                emergencyList.push(deviceName);
                const listItem = document.createElement('li');

                const emergencyButton = document.createElement('a');
                emergencyButton.innerHTML = deviceName + ' ';
                emergencyButton.href = '#';
                emergencyButton.onclick = function () {
                    zoomToMarker(deviceName);
                };
                listItem.appendChild(emergencyButton);

                const removeButton = document.createElement('a');
                removeButton.innerHTML = '(&times;)';
                removeButton.href = '#';
                removeButton.title = 'Remove From Emergency';
                removeButton.onclick = function () {
                    removeDeviceFromEmergencyList(deviceName, listItem);
                };

                listItem.appendChild(removeButton);

                emergencyListPanel.appendChild(listItem);

                // showEmergencyPanel();
            }
        }

        function zoomToMarker(deviceName) {
            const feature = vectorSource.getFeatures().find(feature => feature.get('name') === deviceName);
            if (feature) {
                const coordinates = feature.getGeometry().getCoordinates();
                map.getView().animate({
                    center: coordinates,
                    zoom: 13,
                    duration: 1000,
                });
            }
        }

        function removeDeviceFromEmergencyList(deviceName, listItem) {
            const emergencyListPanel = document.getElementById('emergency-device-list');
            const index = emergencyList.indexOf(deviceName);

            if (index !== -1) {
                emergencyList.splice(index, 1);
            }
            emergencyListPanel.removeChild(listItem);

            if (emergencyList.length === 0) {
                hideEmergencyPanel();
            }

            const emergencyIcon = document.getElementById('emergency-icon');
            emergencyIcon.src = 'https://img.icons8.com/ios-filled/50/000000/siren.png';

            const features = vectorSource.getFormat().readFeatures(geojsonData, {
                featureProjection: map.getView().getProjection(),
            });

            features.forEach(feature => {

                const name = feature.get('name');
                if (name === deviceName) {
                    feature.set('emergency', false);
                }
            });
        }


        function hideEmergencyPanel() {
            const emergencyPanel = document.getElementById('emergency-device-panel');
            emergencyPanel.classList.add('hidden');
        }

        function showEmergencyPanel() {
            const emergencyPanel = document.getElementById('emergency-device-panel');
            emergencyPanel.classList.remove('hidden');
        }

        document.getElementById('download-button').addEventListener('click', downloadSelected);

        let crews = [
            {
                name: "Crew 287",
                passengers: [
                    { name: "Duluu", title: "HSO" },
                    { name: "Tungaa", title: "Psychologist" },
                    { name: "Muggi", title: "Engineer" },
                    { name: "Dono", title: "Commander" },
                    { name: "Sunny", title: "Journalist" },
                    { name: "Davaa", title: "Geologist" }
                ]
            },
            {
                name: "Crew 288",
                passengers: [
                    { name: "Muluu", title: "HSO" },
                    { name: "Sungaa", title: "Psychologist" },
                    { name: "Puggi", title: "Engineer" },
                    { name: "Eno", title: "Commander" },
                    { name: "Munny", title: "Journalist" },
                    { name: "Aavaa", title: "Geologist" }
                ]
            },
            {
                name: "Crew 289",
                passengers: [
                    { name: "Kuluu", title: "HSO" },
                    { name: "Pungaa", title: "Psychologist" },
                    { name: "Vuggi", title: "Engineer" },
                    { name: "Mano", title: "Commander" },
                    { name: "Kunny", title: "Journalist" },
                    { name: "Bavaa", title: "Geologist" }
                ]
            },
        ];

        function populateCrewDropdown(deviceName) {
            const ddlCrews = document.getElementById('ddlCrews');
            ddlCrews.innerHTML = '';

            const filteredCrew = deviceCrew.filter(item => item.device === deviceName);
            // console.log(filteredCrew);
            // const isCrewIncluded = deviceCrew.some(item => item.crew === crew.name);

            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'Select Crew';
            option.selected = filteredCrew.length == 0;
            ddlCrews.appendChild(option);

            crews.forEach(crew => {
                const option = document.createElement('option');
                option.value = crew.name;
                option.textContent = crew.name;
                if (filteredCrew.length > 0) {
                    const isCrewIncluded = filteredCrew.some(item => item.crew === crew.name);
                    if (isCrewIncluded) {
                        option.selected = true;
                    }
                }

                ddlCrews.appendChild(option);
            });
        }

        function addCrew() {
            const selectedDevice = document.getElementById('nameTimeSliderName').innerHTML;
            const ddlCrews = document.getElementById('ddlCrews');
            const selectedCrew = ddlCrews.value;

            if (selectedDevice && selectedCrew) {
                deviceCrew.push({ device: selectedDevice, crew: selectedCrew });
            }
        }

        function removeCrew() {
            const selectedDevice = document.getElementById('nameTimeSliderName').innerHTML;
            const ddlCrews = document.getElementById('ddlCrews');
            ddlCrews.value = '';
            const deviceIndex = deviceCrew.findIndex(item => item.device === selectedDevice);
            if (deviceIndex !== -1) {
                deviceCrew.splice(deviceIndex, 1);
                console.log(`Crew removed for device: ${selectedDevice}`);
            } else {
                console.log(`No crew found for device: ${selectedDevice}`);
            }
        }

        function viewCrew() {
            const ddlCrews = document.getElementById('ddlCrews');
            const selectedCrew = ddlCrews.value;

            const crew = crews.find(item => item.name === selectedCrew);

            if (crew) {
                const modalLabel = document.getElementById('crewModalLabel');
                modalLabel.textContent = `Crew Details - ${crew.name}`;

                const passengerList = document.getElementById('passengerList');
                passengerList.innerHTML = ''; // Clear previous content

                crew.passengers.forEach(passenger => {
                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item';
                    listItem.textContent = `${passenger.title} : ${passenger.name}`;
                    passengerList.appendChild(listItem);
                });

                // Show the Bootstrap modal
                $('#crewModal').modal('show');
            }
        }

        let messages = [];
        localStorage.setItem("messages", JSON.stringify(messages));

        // message update
        document.getElementById("message-post").onsubmit = async (e) => {
            e.preventDefault();
            let value = document.getElementById("form-control").value;
            const response = await fetch("/chat?message=" + encodeURIComponent(value));
            const data = await response.json();
            document.getElementById("form-control").value = "";
            console.log(data);
        }

        function getFeaturesNames() {
            let items = [];
            let markers = document.querySelectorAll(".marker-item");
            markers.forEach(entry => {
                items.push(entry.innerHTML);
            });

            console.log(items);
        }
        const urlParams = new URLSearchParams(window.location.search);
        const name = urlParams.get('name');
        const before_date = urlParams.get('before_date');
        const after_date = urlParams.get('after_date');
        if(name) {
            setTimeout(function() {
                populatePath(name, before_date, after_date);
                zoomToMarker(name);
                populateCrewDropdown(name);
            }, 1000);
        }
    </script>
</body>

</html>
